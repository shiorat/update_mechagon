namespace = wwu_lc_worgen

#------------------------------------
# Spawn in Province
#------------------------------------
province_event = {
    id = wwu_lc_worgen.1
    title = wwu_lc_worgen.1.title
    desc = wwu_lc_worgen.1.desc
    picture = RAGING_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    option = {  
        name = wwu_lc_worgen.1.option.a
        
        ai_chance = { 
            factor = 20 
        }
        
        add_permanent_province_modifier = {
            name = lc_level_worgen_1
            duration = -1  
        }

        custom_tooltip = BOOST_ADVENTURER_SUCCESS_TT
    }
}

#------------------------------------
# Event Manager
#------------------------------------
country_event = {
    id = wwu_lc_worgen.2
    title = wwu_lc_worgen.2.title
    desc = wwu_lc_worgen.2.desc
    picture = BESTIARY_eventPicture
    
    hidden = yes
    is_triggered_only = yes

    trigger = {
        # worgens are present in any province
        any_owned_province = {
            has_any_local_concern = {
                TYPE = worgen
            }
        }
    }
    

    mean_time_to_happen = {
        days = 1
        
        # Increase occurance if multiple worgens are present
        modifier = {
            factor = 2
            
            num_of_owned_provinces_with = {
                value = 3
                has_any_local_concern = {
                    TYPE = worgen
                }
            }
        }
    }

    immediate = {
        # Get worgen target province
        random_owned_province = {
            limit = {
                has_any_local_concern = {
                    TYPE = worgen
                }
            }
            save_event_target_as = lc_worgen_target
        }
    }
    
	
	option = {
        name = wwu_lc_worgen.2.option.a
        
        # worgen target province
        event_target:lc_worgen_target = {
            
            # Randomly pick worgen action
            random_list = {
                #------------------------
                # System
                #------------------------
                # Local Migration
				5 = {
                    modifier = {
                        factor = 2
                        devastation = 75
                    }
                    
					province_event = { id = wwu_lc_worgen.10 }
				}
                
                # Local Growth
                10 = {
                    province_event = { id = wwu_lc_worgen.13 }
                }
                
                # Random Removal
                # Not used here
                
                # Adventurer Removal
                20 = {
                    # Boost if Adventurer estate is loyal
                    modifier = {
                        factor = 2
                        
                        owner = {
                            estate_loyalty = {
                                estate = estate_adventuring_guild
                                loyalty = 60
                            }
                        }
                    }

                    # Boost if Adventurer estate is highly influential
                    modifier = {
                        factor = 2
                        
                        owner = {
                            estate_influence = {
                                estate = estate_adventuring_guild
                                influence = 60
                            }
                        }
                    }
                    
                    # Boost if Adventurer estate is slightly influential
                    modifier = {
                        factor = 1.5
                        owner = {
                            estate_influence = {
                                estate = estate_adventuring_guild
                                influence = 30
                            }
                        }
                    }
                    
                    # Boost if Adventurer estate has Generous Quest Rewards
                    modifier = {
                        factor = 2
                        
                        owner = { has_estate_privilege = estate_adventuring_guild_generous_quest_rewards }
                    }
                    
                    province_event = { id = wwu_lc_worgen.21 }
                }
                
                # Downgrade Tier - Random
                2 = {
                    province_event = { id = wwu_lc_worgen.22 }
                }
                
                # Downgrade Tier - Adventurers
                2 = {
                    # Boost if Adventurer estate is loyal
                    modifier = {
                        factor = 2
                        
                        owner = {
                            estate_loyalty = {
                                estate = estate_adventuring_guild
                                loyalty = 60
                            }
                        }
                    }

                    # Boost if Adventurer estate is highly influential
                    modifier = {
                        factor = 2
                        
                        owner = {
                            estate_influence = {
                                estate = estate_adventuring_guild
                                influence = 60
                            }
                        }
                    }
                    
                    # Boost if Adventurer estate is slightly influential
                    modifier = {
                        factor = 1.5
                        owner = {
                            estate_influence = {
                                estate = estate_adventuring_guild
                                influence = 30
                            }
                        }
                    }
                    
                    # Boost if Adventurer estate has Generous Quest Rewards
                    modifier = {
                        factor = 2
                        
                        owner = { has_estate_privilege = estate_adventuring_guild_generous_quest_rewards }
                    }
                    
                    # Boost if Adventurer estate has Sponser worgen Hunters
                    modifier = {
                        factor = 3
                        
                        owner = { has_estate_privilege = estate_adventuring_guild_sponsor_worgen_hunters }
                    }
                    
                    province_event = { id = wwu_lc_worgen.23 }
                }
                
                # Upgrade Tier - Random
                2 = {
                    modifier = {
                        factor = 2
                        devastation = 25
                        NOT = { devastation = 75 }
                    }
                    province_event = { id = wwu_lc_worgen.30 }
                }
                
                #------------------------
                # Flavour - Tier
                #------------------------

                #------------------------
                # Flavour - General
                #------------------------
                # Worgens infect Settlement
                10 = {
                    province_event = { id = wwu_lc_worgen.200 }
                }
            }
        }
	}
}

# Local Migration
province_event = {
    id = wwu_lc_worgen.10
    title = wwu_lc_worgen.10.title
    desc = wwu_lc_worgen.10.desc
    picture = RAGING_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    trigger = {
        OR = {
            has_local_concern_level_1 = { TYPE = worgen }
            has_local_concern_level_2 = { TYPE = worgen }
        }

        any_neighbor_province = {
            is_city = yes
            
            has_no_local_concern = {
                TYPE = worgen
            }

            NOT = {
                has_banned_terrain = yes
            }
        }
    }
    
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    is_city = yes

                    has_no_local_concern = {
                        TYPE = worgen
                    }
                    
                    NOT = {
                        has_banned_terrain = yes
                    }
                }
                
                save_event_target_as = lc_worgen_target
            }
        }
    }

    # Same Country
    option = {  
        name = wwu_lc_worgen.10.option.a
        goto = lc_worgen_target
        
        ai_chance = { factor = 100 }
        
        trigger = {
            event_target:lc_worgen_target = {
                owned_by = ROOT
            }
        }

        # Remove worgens
        tooltip = {
            remove_local_concern = {
                TYPE = worgen
            }
        }

        # Add worgens to the new province based on the previous province tier
        event_target:lc_worgen_target = {
            if = {
                limit = {
                    owned_by = ROOT
                }

                upgrade_local_concern = {
                    TYPE = worgen
                }
                
                # Remove worgens from the previous province
                PREV = {
                    remove_local_concern = {
                        TYPE = worgen
                    }
                }
            }
        }
    }

    # Different Country
    option = {  
        name = wwu_lc_worgen.10.option.b
        goto = lc_worgen_target
        
        ai_chance = { factor = 100 }
        
        trigger = {
            event_target:lc_worgen_target = {
                NOT = { owned_by = ROOT }
            }
        }

        tooltip = {
            remove_local_concern = {
                TYPE = worgen
            }
        }
        
		custom_tooltip = MIGRATION_WORGEN_DIFFERENT_COUNTRY_TT
        
		hidden_effect = {
			event_target:lc_worgen_target = {
				province_event = {
					id = wwu_lc_worgen.11
				}
			}
		}
    }
}

# Local Migration - Different Country Notification
province_event = {
    id = wwu_lc_worgen.11
    title = wwu_lc_worgen.11.title
    desc = wwu_lc_worgen.11.desc
    picture = RAGING_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    option = {
        name = wwu_lc_worgen.11.option.a
        
        ai_chance = { 
            factor = 20 
        }
        
        custom_tooltip = BOOST_ADVENTURER_SUCCESS_TT

        # Add opinion debuff against original country
        owner = {
            add_opinion = {
                who = FROM
                modifier = lc_crossed_border
            }
        }

        # Add worgens to the new province based on the previous province tier
        upgrade_local_concern_FROM = {
            TYPE = worgen
        }
    }

    after = {
        # Remove worgens from previous province
        FROM = {
            remove_local_concern = {
                TYPE = worgen
            }
        }
    }
}

# Local Growth
province_event = {
    id = wwu_lc_worgen.13
    title = wwu_lc_worgen.13.title
    desc = wwu_lc_worgen.13.desc
    picture = WORGEN_INFILTRATOR_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        has_local_concern_level_3 = { TYPE = worgen }

        any_neighbor_province = {
            has_no_local_concern = {
                TYPE = worgen
            }
        }
    }
    
    immediate = {
        hidden_effect = {
            random_neighbor_province = {
                limit = {
                    is_city = yes

                    has_no_local_concern = {
                        TYPE = worgen
                    }
                }
                
                save_event_target_as = lc_worgen_target
            }
        }
    }

    # Same Country
    option = { 
        name = wwu_lc_worgen.13.option.a
        goto = lc_worgen_target
        
        ai_chance = { factor = 100 }
        
        trigger = {
            event_target:lc_worgen_target = {
                owned_by = ROOT
            }
        }
        
        event_target:lc_worgen_target = {
            if = {
                limit = {
                    owned_by = ROOT
                }
                
                add_local_concern = {
                    TYPE = worgen
                    LEVEL = 1
                }
            }
        }
    }

    # Different Country
    option = {  
        name = wwu_lc_worgen.13.option.b
        goto = lc_worgen_target
        
        ai_chance = { factor = 100 }
        
        trigger = {
            event_target:lc_worgen_target = {
                NOT = { owned_by = ROOT }
            }
        }
		custom_tooltip = MIGRATION_WORGEN_DIFFERENT_COUNTRY_TT
        
		hidden_effect = {
			event_target:lc_worgen_target = {
				province_event = {
					id = wwu_lc_worgen.14
				}
			}
		}
    }
}

# Local Growth - Different Country Notification
province_event = {
    id = wwu_lc_worgen.14
    title = wwu_lc_worgen.14.title
    desc = wwu_lc_worgen.14.desc
    picture = WORGEN_INFILTRATOR_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    option = {
        name = wwu_lc_worgen.14.option.a

        owner = {
            add_opinion = {
                who = FROM
                modifier = lc_crossed_border
            }
        }

        add_local_concern = {
            TYPE = worgen
            LEVEL = 1
        }

        custom_tooltip = BOOST_ADVENTURER_SUCCESS_TT
    }
}


# Adventurer Removal
province_event = {
    id = wwu_lc_worgen.21
    title = wwu_lc_worgen.21.title
    desc = wwu_lc_worgen.21.desc
    picture = ANCIENT_TEACHINGS_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    trigger = {
        owner = { 
            has_estate = estate_adventuring_guild
        }
        
        has_any_local_concern = {
            TYPE = worgen
        }
    }
    
    option = {
        name = wwu_lc_worgen.21.option.a
        
        ai_chance = { factor = 100 }

        remove_local_concern = {
            TYPE = worgen
        }

        owner = {
            add_estate_influence_modifier = {
                estate = estate_adventuring_guild
                desc = EST_VAL_LC_RESOLVED_LC_ENCOUNTER
                duration = 3650
                influence = 5
            }
        }

        owner = { 
            add_prestige = 10
        }
    }
}

# Downgrade Tier - Random
province_event = {
    id = wwu_lc_worgen.22
    title = wwu_lc_worgen.22.title
    desc = wwu_lc_worgen.22.desc
    picture = TWISTED_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    trigger = {
        has_any_local_concern = {
            TYPE = worgen
        }
    }
    option = {
        name = wwu_lc_worgen.22.option.a
        
        ai_chance = { factor = 100 }
        
        downgrade_local_concern = {
            TYPE = worgen
        }
    }
}

# Downgrade Tier - Adventurers
province_event = {
    id = wwu_lc_worgen.23
    title = wwu_lc_worgen.23.title
    desc = wwu_lc_worgen.23.desc
    picture = RAGING_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    trigger = {
        owner = { 
            has_estate = estate_adventuring_guild
        }
        
        has_any_local_concern = {
            TYPE = worgen
        }
    }
    option = {
        name = wwu_lc_worgen.23.option.a
        
        ai_chance = { factor = 100 }
        
        downgrade_local_concern = {
            TYPE = worgen
        }

        owner = {
            add_prestige = 10
            
            add_estate_influence_modifier = {
                estate = estate_adventuring_guild
                desc = EST_VAL_LC_RESOLVED_LC_ENCOUNTER
                duration = 3650
                influence = 5
            }
        }
    }
}

# Upgrade Tier - Random
province_event = {
    id = wwu_lc_worgen.30
    title = wwu_lc_worgen.30.title
    desc = wwu_lc_worgen.30.desc
    picture = WORGEN_INFILTRATOR_eventPicture
    goto = ROOT
    
    hidden = no
    is_triggered_only = yes
    
    trigger = {
        OR = { 
            has_local_concern_level_1 = { TYPE = worgen }
            has_local_concern_level_2 = { TYPE = worgen }
        }
    }
    option = {
        name = wwu_lc_worgen.30.option.a
        
        ai_chance = { factor = 100 }

        add_devastation = 10

        add_or_upgrade_local_concern = {
            TYPE = worgen
        }

        custom_tooltip = BOOST_ADVENTURER_SUCCESS_TT
    }
}

# Worgen Infection
province_event = {
    id = wwu_lc_worgen.200
    title = wwu_lc_worgen.200.title
    desc = wwu_lc_worgen.200.desc
    picture = RAGING_WORGEN_eventPicture
    goto = ROOT
    
    is_triggered_only = yes
    
    trigger = {
        has_any_local_concern = {
            TYPE = worgen
        }
        
        OR = {
            culture = culture_stormwindian
            culture = culture_gilnean
            culture = culture_arathi
            culture = culture_lordaeron
            culture = culture_alterac
            culture = culture_kul_tiran
            culture = culture_dalaran
            culture = culture_night_elf
        }
    }
    
    option = {
        name = wwu_lc_worgen.200.option.a
        
        if = {
            limit = {
                culture = culture_stormwindian
            }
            change_culture = culture_stormwindian_worgen
        }
        if = {
            limit = {
                culture = culture_gilnean
            }
            change_culture = culture_gilnean_worgen
        }
        if = {
            limit = {
                culture = culture_arathi
            }
            change_culture = culture_arathi_worgen
        }
        if = {
            limit = {
                culture = culture_lordaeron
            }
            change_culture = culture_lordaeron_worgen
        }
        if = {
            limit = {
                culture = culture_alterac
            }
            change_culture = culture_alterac_worgen
        }
        if = {
            limit = {
                culture = culture_kul_tiran
            }
            change_culture = culture_kul_tiran_worgen
        }
        if = {
            limit = {
                culture = culture_dalaran
            }
            change_culture = culture_dalaran_worgen
        }
        if = {
            limit = {
                culture = culture_night_elf
            }
            change_culture = culture_night_elf_worgen
        }
        
        add_devastation = 50
    }
}
